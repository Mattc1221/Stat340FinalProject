---
title: "Stat 340 Group Progress Report"
date: "11/11/2021"
output:
  html_document: default
  pdf_document: default
---

***

**Matthew Chiang**:     907 723 8120 (Mchiang7)

**Ishaan Backliwal**:   908 134 7719 (backliwal)

**Jordan Livingston**:  908 132 1151 (jlivingston4)

**Eric Dietze**:        907 935 8843 (edietze)

**Vu Pham**:            907 808 5595 (vmpham2)

***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
# install.packages("cowplot")
library(cowplot)
library(knitr)
library(stringr)
```

## Description of Data

Baseball is an American sport played between two teams. One team plays defense and has a player (pitcher) try to throw the ball past the other team's batter who tries to hit the ball. If the batting team successfully hits the ball enough times they can score runs (points). We will use data sets from baseball-reference.com which contain team and individual statistics. This database also offers data ‘splits’, which show comparisons between home and away games. For our primary analysis, we will be focusing on the Houston Astros 2017 Team Batting Splits and the 2017 Individual Player Batting Splits. These data sets outline various different statistics of the Houston Astros 2017 season in which it was confirmed that they had cheated in home games. We will use the ‘splits’ data sets to determine a difference of statistics between home and away games. This database also contains data on the Astros for different seasons and different teams. Depending on the results of our initial analysis, we will compare the players on the roster of the 2017 Astros to previous seasons to determine a difference in performance before and after cheating. Our statistical question is whether or not the 2017 Houston Astros cheated. Two years after the alleged cheating occured, reports from a player who was on the 2017 Astros alleged that there were cameras positioned in the Astros home field stadium, Minute Maid Park in Houston, that could see the relayed signs between the pitcher and catcher. Note: the catcher communicates to the pitcher what pitch the pitcher should throw based on a series of hand movements in between pitches. The Houston Astros camera could see these hand signals and people were in charge of watching the film and decoding the symbols to determine what pitch was coming. Once a pitch was shown, members of the Astros would relay what pitch was coming to the batter through their own series of symbols (most infamously a banging of a garbage can). 

The Astros only had this technology at their Home Stadium, so they should have higher performance at home compared to on the road. Note: this sign decoding should reason that only their batting improved at home and not their pitching. We used several stats for measuring their performance. 

### *Statistical Questions*
+ Is there a noticeable difference between the batting splits for home and away games of the Houston Astros team during the 2017 season?
+ How does this difference, if any, compare to other teams’ performance in the MLB during the 2017 season?
+ Is there sufficient statistical evidence to suggest the Houston Astros benefited from cheating in the 2017 season? 
  + If there is, how much may the cheating have affected their season? And what would their season have looked like if they didn’t cheat?
  
## Why We Chose This Dataset
+ This has been a controversy within the baseball community regarded to be one of the biggest cheating scandals in the sport's history.
+ In 2017 the Houston Astros won the world series. However, it came out in November of 2019 that they were using technology to steal signs during home games.
+ To us, this data set is interesting because it contains (in detail) records of each game, each player, and almost all variables that could take place in this event. So, this dataset is very in depth and useful for testing hypotheses thoroughly regarding the incident. Like they said “Numbers don’t lie”!

## Variables

Below is a list of some important variables in our dataset:
```{r echo=FALSE}
variables <- read.csv("./data/variable_descriptions.csv")
kable(variables)
```

## Loading Data

```{r}
# will store the data for all teams in the 2017 season
season_2017 <- NA
data_empty <- TRUE

# Getting initial path data
data_path <- "./data"
data_dirs <- list.files(data_path)
data_dirs <- data_dirs[!str_detect(data_dirs, ".csv")]

# iteratively get all csv file paths and store them
for(path in data_dirs){
  # gets the directory for a spefic teams csv files
  team_dir <- paste(data_path, path, sep="/")
  csv_list <- list.files(team_dir)
  
  # steps through csv files, loads and edits them as dataframes
  for(csv in csv_list){
    # get full path, and other information from csv name
    full_path <- paste(team_dir, csv, sep="/")
    split <- ifelse(str_detect(csv, "home"), "HOME", "AWAY")
    team_name <- str_split_fixed(team_dir, pattern="data/", 2)[2]
    
    # Read in data
    df <- read.csv(full_path)%>%
      mutate(Name = str_split_fixed(Name, "\\\\", 2)[,1]) %>%
      mutate(split = split, team = team_name)
    df <- df[ -length(df[,1]), ]
    
    # binds all teams data together
    if(data_empty){
      season_2017 <- df
      data_empty <- FALSE
    }else {
      season_2017 <- rbind(season_2017, df, make.row.names=TRUE)
    }
  }
}
astros_2017 <- season_2017 %>%
  filter(team=="astros", AB != 0)
```

```{r include=FALSE}
team_visualize <- function(team_df, label_name){
  ops <- team_df %>%
  select(OPS, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=OPS, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
runs <- team_df %>%
  select(R, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=R, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
hits <- team_df %>%
  select(H, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=H, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
batting_avg <- team_df %>%
  select(BA, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=BA, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
home_run <- team_df %>%
  select(HR, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=HR, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
rbi <- team_df %>%
  select(RBI, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=RBI, fill=split)) + 
    theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

label_name <- paste(label_name, "data - Home vs Away") 

boxplot_grid <- plot_grid(ops, runs, hits, batting_avg, home_run, rbi, ncol=2)
title <- ggdraw() + draw_label(label_name, fontface='bold')
return(plot_grid(title, boxplot_grid, ncol=1, rel_heights=c(0.1, 1)))
}


not_astros <- season_2017 %>%
  filter(team!="astros", AB != 0)
```



```{r}
# Loading Data pt 2
# btw this sucked
wins_and_losses_2017 <- read.csv("./data/win_loss_2017.csv") %>%
  mutate(split = gsub(" ", "", split, fixed = TRUE), team = gsub(" ", "", team, fixed = TRUE)) %>%
  mutate(split = toupper(split))
```

## Preliminary Plots

### *Comparing The Astros 2017 Home and Away Data*

to start we will look at some of the variables we take a look some comparisons of specific variables between home and away games.

```{r, echo=FALSE}
ops <- astros_2017 %>%
  select(OPS, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=OPS, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
runs <- astros_2017 %>%
  select(R, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=R, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
hits <- astros_2017 %>%
  select(H, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=H, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
batting_avg <- astros_2017 %>%
  select(BA, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=BA, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
home_run <- astros_2017 %>%
  select(HR, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=HR, fill=split)) + 
    theme(legend.position = "none", 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
rbi <- astros_2017 %>%
  select(RBI, split) %>%
  drop_na() %>%
  ggplot() +
    geom_boxplot(aes(x=RBI, fill=split)) + 
    theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

boxplot_grid <- plot_grid(ops, runs, hits, batting_avg, home_run, rbi, ncol=2)
title <- ggdraw() + draw_label("Astros 2017 data - Home vs Away", fontface='bold')
plot_grid(title, boxplot_grid, ncol=1, rel_heights=c(0.1, 1))
```

***

These box plots show how there is a clear difference between home and away games. The largest difference is in average Hits (H) per season that a player gets between home and away games. 

***

### *Runs analysis - Home vs. Away*

To do this analysis, we will be doing a monte carlo simulation on the difference of average runs a player gets per season between home and away games. Runs will be modeled by a poisson random variable. Under the assumption that Runs from home and away games comes from the same distribution, we will set lambda as the mean of runs for home and away games combined. 

```{r mc_runs, echo=FALSE}
runs_simulation <- function(n1, n2, avg){
  home_runs <- mean(rpois(n1, avg))
  away_runs <- mean(rpois(n2, avg))
  return(away_runs - home_runs)
}

runs_mc <- function(n1, n2, avg, reps = 1000){
  mean_differences <- rep(NA, reps)
  for(i in 1:reps){
     difference <- runs_simulation(n1, n2, avg)
     mean_differences[i] <- difference
  }
  return(mean_differences)
}

run_data <- astros_2017 %>%
  select(R, split) %>%
  drop_na()

player_run_avg <- mean(run_data$R)
num_home <- count(filter(run_data, split=="HOME"))$n
num_away <- count(filter(run_data, split=="AWAY"))$n

runs_sim <- runs_mc(num_home, num_away, player_run_avg)
home_away_runs_difference <- mean(filter(run_data, split=="AWAY")$R)-mean(filter(run_data, split=="HOME")$R)
runs_ci <- quantile(as.vector(runs_sim), prob=c(0.025, 0.975))

data.frame(diff = runs_sim)%>%
  ggplot() +
  geom_histogram(aes(x=diff), bins = 30) +
  geom_vline(aes(xintercept = home_away_runs_difference, color="Observed Difference"),lwd= 1) +
  geom_vline(aes(xintercept = c(runs_ci[1]), color="Confidence Interval"),lwd= 1) +
  geom_vline(aes(xintercept = c(runs_ci[2]),color="Confidence Interval"),lwd= 1) +
  scale_color_manual(
    name = "Legend", 
    values = c("Confidence Interval" = "#34c4cc", "Observed Difference" = "#ec8274")) +
  xlab("Difference of Averages") +
  ylab("Frequency") +
  ggtitle("Difference of Average Player Runs", subtitle = "Home vs. Away - Astros 2017")
```

***

After performing a 95% confidence interval on our data, we see that our observed difference falls outside of the confidence interval, leading us to reject our initial assumption. Thus, we can say with 95% confidence that there is statistical significance in the difference of Run means between home and away games. 

However, because Away game Runs are lower than Home game Runs, this implies that the Atros cheating had a positive effect on their performance.

***

### *Is It Just a Home-Field Advantage*

Since our original statistical question is basically "can we prove that the Astros cheated in the 2017 season?" we want to determine if the results we found in the confidence interval above just prove that a home field advantage exists or if the Astros have a better home field advantage due to the existence of cheating.

To do this we will perform some two sample t tests to determine a difference between the average statistics between Astros at home and other teams at their home stadium. We have realized that sign stealing should have a higher effect on players batting averages because it allowed the astros players to know which kind of pitch was coming in and thus have a better chance at hitting the ball. Batting Average is calculated as $BA = Hits / At Bats$.

```{r echo=FALSE}
astros_home = astros_2017 %>%
  filter(split == "HOME")
astros_away = astros_2017 %>%
  filter(split == "AWAY")

```
```{r echo=FALSE}
# 2 sample t,tests on 3 major stats in mlb of astros home vs astros away
t.test(astros_home$BA,astros_away$BA) 
# t.test(astros_home$HR,astros_away$HR)
# t.test(astros_home$RBI,astros_away$RBI)
```

Above we see that the batting average of the Astros is significantly better at home than away. This again does not show conclusive evidence that they cheated, but instead adds strength to our earlier analysis that the Astros definitely have some sort of a home field advantage. Next we will compare the Astros with the rest of the league, by performing another two sample t test between the astros home games and the home games of all other teams in the league.

```{r echo=FALSE}
#head(not_astros)
c = not_astros %>%
  filter(split == "HOME")
#better than other teams when they are at home at significant stats
t.test(astros_home$BA,c$BA) 
# t.test(astros_home$HR,c$HR)
# t.test(astros_home$RBI,c$RBI)

#HR is significantly better
```

Here the results do not lead us anywhere conclusive as our p-value is too high to reject the hypothesis that the true mean of the distribution of the Astros batting average is the same as the true mean of the batting average of all other teams. We have also tried this in other variables in our data set as well, however the results have all been similar. There is no distinction between the astros home statistics versus other teams home statistics.

```{r echo=FALSE, include=FALSE}
d = not_astros %>%
  filter(split == "AWAY")
t.test(astros_away$BA,d$BA) 
t.test(astros_away$HR,d$HR)
t.test(astros_away$RBI,d$RBI)
#still perform better but not as strong as the home stats
```

```{r echo=FALSE, include=FALSE}
t.test(astros_home$sOPS.,astros_away$sOPS.)
#t.test(a$tOPS.,b$tOPS.)

#significant better when astros is at home than when astros is away and other teams are at home (should look more at p val maybe ?)
```


```{r include = FALSE}
## Disregard this, but I think Jordan wanted me to keep it in here

pool <- season_2017 %>%
  select(team, split, BA, AB) %>%
  drop_na(BA) %>%
  filter(BA != 0) %>%
  filter(AB >= 130) %>%
  select(-AB) %>%
  group_by(team,split) %>%
  # filter(BA >= sort(BA, decreasing=TRUE)[20]) %>%
  mutate(avg_ba = mean(BA)) %>%
  select(-BA) %>%
  unique() %>%
  group_by(team) %>%
  mutate(diff_ba = max(avg_ba)-min(avg_ba)) #%>%
  # select(-split, -avg_ba) %>%
  # unique()

?drop_na

not_astros_ba <- pool %>%
  filter(team != "astros")
  
arrange(pool, diff_ba)
not_astros_ba

hist(not_astros_ba$diff_ba)

as.vector(quantile(not_astros_ba$diff_ba, probs=c(0.025, 0.975)))
# pool <- pool$avg_runs
# odd <- seq(1, length(pool), 2)
# even <- seq(2, length(pool), 2)
# pool <- pool[even] #- pool[odd]
# reps <- 1000
# 
# samples <- rep(NA, reps)
# 
# for(i in 1:reps){
#   samples[i] <- sample(pool, size = 1, replace = TRUE)
# }
# 
# as.vector(quantile(samples, prob = c(0.025, .975)))
# 
# df <- data.frame(diffs = pool)
# 
# ggplot(df, aes(x=diffs)) +
#   geom_histogram()

# df <- data.frame(home = pool[even], away = pool[odd])
```

### *A New Approach*

So far it seems that our data is too general for our statistical question. There are a myriad of different factors that play into how a team does in a season, differing game to game. We believe that to tackle this question we need to take a loot at more in-depth statistics than just player hits, batting average, etc. We have found a new dataset from "Baseball Savant" that offer's player data for the percent of pitches that are out of the strike zone that a player swings at and the percent of pitches that are in the strike zone that a player swings at.


```{r}
test = data.frame(
  player= c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m",
            "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m"),
  IZP = c(.1, .2, .3, .4, .5, .6, .7, .8, .9, .8, .14, .35, .66, 
          .2, .25, .35, .45, .55, .65, .75, .85, .95, .85, .145, .355, .56),
  OZP = c(.15, .25, .35, .45, .55, .65, .76, .86, .96, .86, .146, .356, .65, 
          .2, .28, .38, .48, .58, .68, .75, .85, .95, .85, .145, .355, .56),
  year = c("2017","2017","2017","2017","2017","2017","2017","2017","2017","2017","2017","2017","2017",
           "2016","2016","2016","2016","2016","2016","2016","2016","2016","2016","2016","2016","2016"),
  team = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M",
           "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M")
)


IZP_diffs <- test %>%
  drop_na() %>%
  group_by(player) %>%
  mutate(change_IZP = (IZP[2] -IZP[1]), change_OZP = (OZP[2] -OZP[1])) %>%
  select(player, team, change_IZP, change_OZP) %>%
  unique() %>%
  arrange(desc(change_IZP)) %>%
  mutate(team=ifelse(team=="A", "astros", "not_astros"))
IZP_diffs$order <- 1:length(IZP_diffs$change_IZP)
IZP_diffs %>%
  ggplot() +
  geom_col(aes(x=order, y =change_IZP, fill = team))
  
```
```{r}
zones <- read.csv('./data/zone_swings.csv')
zones_clean <- zones %>%
  unite('Name', first_name:last_name, remove = TRUE) %>%
  mutate(Name = str_replace(Name, "_", " ")) %>%
  select(Name, out_zone_swing, in_zone_swing) %>%
  arrange(Name)

astros_zones_2017 <- merge(astros_2017, zones_clean, by = "Name", all = TRUE)
astros_zones_2017
zones_clean
```

## Discussion on Progress/Challenges


**Challenges**:

+ On our last project report, the results that we gathered from the data were not what we expected. We originally cleaned the dataset wrong and it affected the outcome, giving us reason to believe the Astros didn't cheat. After going back and changing how we read in the data, our graphs prove what we were originally expecting, and show initial evidence that they were cheating. Our original findings were very surprising because this cheating scandal wouldn't have been a scandal if it weren't for some correlation and evidence that suggest they did. This was a big challenge because after our last project report, we thought we were gonna have to go back and change our whole project. But now we are back on track and can continue the analysis of our questions.

+ Another challenge we faced during this project report was trying to figure out how to use a linear model in our analysis. We originally wanted to use a regression model on all of the variables in our dataset to predict wins and then we could see if home games (the supposed cheating) was a statistically significant variable. After initially trying this, we realized this approach was not a very good/strong indication of how home games helped them cheat. Then, we thought it would be beneficial to compare individual Astro players pre-season stats, to that of the regular season, and compare home and away. This also came with its issues though because there wasn't individual player data for preseason. So we moved onto our next thought process

+ From the data site Kieth gave us from the last project report, we found a perfect data set split up into the home and away games, but there were no column names for 161 variables. So we used python to assign column names from the reference sheet online. 

+ In doing this, we found out how hard it is to try and piece together all the datasets. This method also increases the margin of error, which is something we can compute and analyze for the final report. 


**Progress**:

+ We came to the realization that some of our data cleaning from our last project report was skewing the results. We fixed that problem, re-fit the previous graphs, and re-analyzed them

+ We spend a tremendous amount of time reading in new data and cleaning it, in order to form a regression model. After forming a linear model to predict win_percentage based on Runs, Hits, Runs Batted In, Home Runs, and Split (Home vs, Away), we found that the model sucks, like a lot. So we will need to adapt our model to work better in the future, but we did not have enough time to finish it now.

+ In experimenting with different ways to analyze home and away splits, we found that creating our own batting average would be best because we could create one for each home and away game according to the player. In doing this we also realized that teams rosters are different for home and away and this, along with players who never got up the the plate once in a whole season were skewing our results. In an attempt to resolve this, we only analyzed players who got up to bat once per game, or 162 times for all the regular season games in the pre-covid 2017 season.


## Next Steps

+ We want to figure out why the new regression models we created were so bad. Before the final project is due, we will work on how to improve our model, and attend office hours to gain some insight as why they currently are the way they are. We can then plot the models to visually see how they are doing 


+ We also might want to look into the performance of teams throughout the league at the Astros' home stadium to see if the conditions under which teams play at that location (called park factors) have any affect on performance, indicating a possible reason for the Astros lower performance at home.

+ We are also considering looking into things such as individual Astros players performance and test to see if there were any noticeable, improbable differences between years, comparing it to the change in performance for other teams' top performers. 




